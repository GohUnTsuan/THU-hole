{"code": 0, "data": [{"cid": 3144776, "deleted": false, "image_metadata": {"h": 213, "w": 837}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": -1, "tag": null, "text": "## 获取你的token\n\n在浏览器中打开树洞，按`F12`打开开发者工具，点击“网络”：", "timestamp": 1639222432, "type": "image", "url": "cc/cceglyopcgnf5fegdy3digpccx2cxeh6.jpeg"}, {"cid": 3144777, "deleted": false, "image_metadata": {"h": 122, "w": 327}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": -1, "tag": null, "text": "之后在网页上点击“关注”。", "timestamp": 1639222445, "type": "image", "url": "vc/vcbzmxanq3h63q27hlktckmh3nlfrlzq.jpeg"}, {"cid": 3144778, "deleted": false, "image_metadata": {"h": 377, "w": 1085}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": -1, "tag": null, "text": "打开开发者工具，点击以`attention`开头的网络请求。", "timestamp": 1639222458, "type": "image", "url": "bn/bnr336nqnr54laccpb77kvk2odsnr2ly.jpeg"}, {"cid": 3144781, "deleted": false, "image_metadata": {"h": 545, "w": 1066}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": -1, "tag": null, "text": "滚动到页面底部，即可看到你的token：", "timestamp": 1639222467, "type": "image", "url": "qe/qe72l2vyiy7ocu6pdqb3ouskg27ya223.jpeg"}, {"cid": 3144782, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Alice", "pid": 595705, "reply_to": -1, "tag": null, "text": "火钳刘明", "timestamp": 1639222478, "type": "text", "url": ""}, {"cid": 3144788, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Bob", "pid": 595705, "reply_to": -1, "tag": null, "text": "注意每个账号每天只有8000次请求机会", "timestamp": 1639222511, "type": "text", "url": ""}, {"cid": 3144794, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Carol", "pid": 595705, "reply_to": -1, "tag": null, "text": "留名\n", "timestamp": 1639222619, "type": "text", "url": ""}, {"cid": 3144805, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Dave", "pid": 595705, "reply_to": -1, "tag": null, "text": "都这么搞，树洞怕是在停服前就先崩了...", "timestamp": 1639222754, "type": "text", "url": ""}, {"cid": 3144829, "deleted": false, "image_metadata": {}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": -1, "tag": null, "text": "希望同学们不要修改代码里`SLEEP_TIME`，不然可能会对树洞服务器造成较大的负担。＞﹏＜", "timestamp": 1639223168, "type": "text", "url": ""}, {"cid": 3144880, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Eve", "pid": 595705, "reply_to": -1, "tag": null, "text": "虽然，但是可能不懂代码的同学本来不知道sleeptime的意思的2333", "timestamp": 1639223774, "type": "text", "url": ""}, {"cid": 3144911, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Francis", "pid": 595705, "reply_to": -1, "tag": null, "text": "Re 洞主: 请问这个程序能保存关注帖子里链接到的别的帖子吗", "timestamp": 1639224085, "type": "text", "url": ""}, {"cid": 3144967, "deleted": false, "image_metadata": {}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": 3144911, "tag": null, "text": "Re Francis: 不行。dz水平不够只是抛砖引玉（＾▽＾）", "timestamp": 1639224784, "type": "text", "url": ""}, {"cid": 3144970, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Grace", "pid": 595705, "reply_to": 3144911, "tag": null, "text": "哈哈有人发了啊，刚刚也写了一个#595732", "timestamp": 1639224794, "type": "text", "url": ""}, {"cid": 3144990, "deleted": false, "image_metadata": {"h": 266, "w": 1280}, "is_dz": false, "name": "Francis", "pid": 595705, "reply_to": -1, "tag": null, "text": "", "timestamp": 1639224956, "type": "image", "url": "2z/2zot5drbsy6y7v43zjulyl5kwl33txkf.jpeg"}, {"cid": 3144999, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Grace", "pid": 595705, "reply_to": 3144970, "tag": null, "text": "dz这个好像不能下载图片？想下图片的同学可以用Grace那个", "timestamp": 1639225070, "type": "text", "url": ""}, {"cid": 3145002, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Francis", "pid": 595705, "reply_to": 3144990, "tag": null, "text": "Re Francis: 请问我是操作错了什么地方。。。？", "timestamp": 1639225095, "type": "text", "url": ""}, {"cid": 3145026, "deleted": false, "image_metadata": {}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": -1, "tag": null, "text": "Re Francis: 啊这我也不太清楚😥", "timestamp": 1639225508, "type": "text", "url": ""}, {"cid": 3145030, "deleted": false, "image_metadata": {}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": 3144999, "tag": null, "text": "Re Grace: 确实不能下载图片，膜拜大佬的爬虫", "timestamp": 1639225566, "type": "text", "url": ""}, {"cid": 3145031, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Hans", "pid": 595705, "reply_to": -1, "tag": null, "text": "爬完了之后那个json文件怎么看哇？打开是一堆乱码", "timestamp": 1639225577, "type": "text", "url": ""}, {"cid": 3145063, "deleted": false, "image_metadata": {}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": 3145031, "tag": null, "text": "Re Hans: 有个html文件（同目录下的result.html），打开就能看到了。那个json文件是utf-8编码，没保存成中文是我疏忽了。", "timestamp": 1639225858, "type": "text", "url": ""}, {"cid": 3145081, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Hans", "pid": 595705, "reply_to": 3145063, "tag": null, "text": "Re 洞主: 太感谢dz了！谢谢你😘", "timestamp": 1639226036, "type": "text", "url": ""}, {"cid": 3145258, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Isabella", "pid": 595705, "reply_to": 3145063, "tag": null, "text": "Re 洞主: 为什么运行代码之后显示系统找不到指定的文件啊", "timestamp": 1639228340, "type": "text", "url": ""}, {"cid": 3145292, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Jason", "pid": 595705, "reply_to": -1, "tag": null, "text": "requests.exceptions.SSLError: HTTPSConnectionPool(host='tapi.thuhole.com', port=443): Max retries exceeded with url: /v3/contents/post/attentions?page=1&device=0&v=v3.0.6-455336 (Caused by SSLError(SSLEOFError(8, 'EOF occurred in violation of protocol (_ssl.c:1129)')))\n请问这是什么错误呢？我应该远没有到8000条", "timestamp": 1639229023, "type": "text", "url": ""}, {"cid": 3145324, "deleted": false, "image_metadata": {}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": 3145258, "tag": null, "text": "Re Isabella: 可能是把保存代码的路径打错了？", "timestamp": 1639229646, "type": "text", "url": ""}, {"cid": 3145332, "deleted": false, "image_metadata": {}, "is_dz": true, "name": "洞主", "pid": 595705, "reply_to": 3145292, "tag": null, "text": "Re Jason: 是https证书的问题。导致问题的原因有很多种，可以看看这个帖子里的解决方案：https://stackoverflow.com/questions/33410577/python-requests-exceptions-sslerror-eof-occurred-in-violation-of-protocol", "timestamp": 1639229774, "type": "text", "url": ""}, {"cid": 3145561, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Eve", "pid": 595705, "reply_to": -1, "tag": null, "text": "感觉可以加个过程文件保存attentionlist，不然后面根据list来get的时候如果断了的话又得重新读一遍", "timestamp": 1639234462, "type": "text", "url": ""}, {"cid": 3145565, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Eve", "pid": 595705, "reply_to": 3145561, "tag": null, "text": "Re Eve: 这样就算中途断了的话，也能自己去attentionlist里去掉已经下载的洞号，省事", "timestamp": 1639234541, "type": "text", "url": ""}, {"cid": 3146761, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Louis", "pid": 595705, "reply_to": -1, "tag": null, "text": "html文件是只有程序运行完才生成的是吗？", "timestamp": 1639272978, "type": "text", "url": ""}, {"cid": 3146762, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Louis", "pid": 595705, "reply_to": -1, "tag": null, "text": "py小白在线提问", "timestamp": 1639272992, "type": "text", "url": ""}, {"cid": 3146958, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Margaret", "pid": 595705, "reply_to": -1, "tag": null, "text": "想问问怎么获取token？网页版树洞好像登不上呀？", "timestamp": 1639280470, "type": "text", "url": ""}, {"cid": 3147131, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Nathan", "pid": 595705, "reply_to": -1, "tag": null, "text": "dz在吗？怎么爬热榜呀", "timestamp": 1639284963, "type": "text", "url": ""}, {"cid": 3147320, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Eve", "pid": 595705, "reply_to": 3146761, "tag": null, "text": "Re Louis: 对的，dump_as_html就是把每个关注的json投到html里", "timestamp": 1639290743, "type": "text", "url": ""}, {"cid": 3147324, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Eve", "pid": 595705, "reply_to": 3146958, "tag": null, "text": "Re Margaret: app不知道要不要翻墙，网页版一定要翻墙", "timestamp": 1639290794, "type": "text", "url": ""}, {"cid": 3148355, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Olivia", "pid": 595705, "reply_to": -1, "tag": null, "text": "改进了一下，判断了本地路径下已下载过的洞的原始数据json不再去发请求获取；对已删的洞的异常处理（留空）；输出的html带上了洞内容的图片链接；", "timestamp": 1639321197, "type": "text", "url": ""}, {"cid": 3148357, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Olivia", "pid": 595705, "reply_to": -1, "tag": null, "text": "以及原始数据保存得更全些", "timestamp": 1639321220, "type": "text", "url": ""}, {"cid": 3148376, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Olivia", "pid": 595705, "reply_to": -1, "tag": null, "text": "改了 get_post(post_pid)函数里面的：\n```\n    content = json.loads(req.text)\n    post = content['post']\n    reply = list(map(lambda x: (x['name'], x['text'], x['type'], x['url']), content['data']))\n    return post, reply\n```\n\n及从原始数据 json生成 html的函数做了大改，加上了 [TAG]、日期时间、和图片链接：\n```\ndef dump_as_html():\n    post_list = list(Path('posts').glob('*.json'))\n    post_list = sorted(post_list, key=lambda x:int(x.stem), reverse=True)\n\n    result_html = ''\n    for post_path in post_list:\n        try:\n            with open(post_path) as f:\n                post = json.load(f)\n        except Exception as JSONDecodeError:\n             result_html += f'<h1>{post_path.stem}</h1>'\n             continue\n\n        result_html += f'<h1>{post_path.stem}'\n        if post['post']['tag']: result_html += ' ['+str(post['post']['tag'])+']'\n        result_html += '</h1>'\n        result_html += datetime.fromtimestamp(post['post']['timestamp']).strftime(\"%Y/%m/%d, %H:%M:%S\")+'<br>'\n\n        PostReply = post['post']['text'].replace('\\n', '<br>')\n        result_html += PostReply\n        \n        PostUrl=post['post']['url']\n        if post['post']['type']==\"image\": result_html += f'<br/><a href=\"https://i.thuhole.com/{PostUrl}\">{PostUrl}</a></li>'\n        \n        result_html += '<ul>'\n        for name, reply, Rtype, url in post['reply']:\n            reply = reply.replace('\\n', '<br>')\n            result_html += f'<li>[{name}] {reply}'\n            if Rtype==\"image\": result_html += f'<br/><a href=\"https://i.thuhole.com/{url}\">{url}</a></li>'\n        result_html += '</li></ul>'\n\n    with open('result.html', 'w', encoding='utf-8') as f:\n        f.write(result_html)\n```", "timestamp": 1639321529, "type": "text", "url": ""}, {"cid": 3148387, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Olivia", "pid": 595705, "reply_to": 3148376, "tag": null, "text": "修改从 pid_list获取 posts内容的函数，判断已存在的json数据则跳过获取：\n```python\ndef dump_all_posts(pid_list):\n    Path('posts/').mkdir(exist_ok=True)\n    for post_id in pid_list:\n        try: #判断文件已存在则跳过\n            f = open('posts/{}.json'.format(post_id),'r')\n            f.close() \n        except Exception:\n            with open('posts/{}.json'.format(post_id), 'w') as f:\n                try:\n                    post, reply = get_post(post_id)\n                    json.dump({'post': post, 'reply': reply}, f)\n                except Exception:\n                    print(post_id,'Posts Error')\n```", "timestamp": 1639321731, "type": "text", "url": ""}, {"cid": 3148908, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Paul", "pid": 595705, "reply_to": 3148376, "tag": null, "text": "Re Olivia: TypeError: string indices must be integers  运行后报错了，请问是怎么回事呢？", "timestamp": 1639334946, "type": "text", "url": ""}, {"cid": 3149139, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Olivia", "pid": 595705, "reply_to": -1, "tag": null, "text": "对了，上面 json输出 html的代码，fix了html文本无换行的问题", "timestamp": 1639362153, "type": "text", "url": ""}], "post": {"deleted": false, "image_metadata": {}, "likenum": 268, "pid": 595705, "reply": 39, "tag": null, "text": "# 用Python备份你的关注列表\n\n## 使用方法\n\n* 安装requests库：`pip install requests`或`python -m pip install requests`\n* 复制并运行以下代码，按照提示输入你的token。\n* 结果将储存在`result.html`，帖子数据储存在`posts/`目录下\n\n```python\nimport requests\nimport json\nimport time\nimport pathlib\nfrom pathlib import Path\n\nSLEEP_TIME = 2.0\nheaders = {'token': ''}\n\ndef get_attention_list_by_page(page_id):\n    print('get attention list: page:', page_id)\n\n    url = 'https://tapi.thuhole.com/v3/contents/post/attentions'\n    params = {\n        'page': page_id,\n        'device': 0,\n        'v': 'v3.0.6-455336'\n    }\n    req = requests.get(url=url, headers=headers, params=params)\n    time.sleep(SLEEP_TIME)\n    \n    if (req.status_code != 200):\n        print('  Error code:', req.status_code)\n        return get_attention_list_by_page(page_id)\n    else:\n        print('  Success.')\n\n    content = json.loads(req.text)\n    return list(content['comments'].keys())\n\ndef get_attention_list():\n    page_id = 1\n    attention_list = []\n    while True:\n        attention_list_page = get_attention_list_by_page(page_id)\n        if len(attention_list_page) == 0:\n            break\n        attention_list += attention_list_page\n        page_id = page_id + 1\n        \n    return list(map(lambda x: int(x), attention_list))\n\ndef get_post(post_id):\n    print('get post:', post_id)\n\n    url = 'https://tapi.thuhole.com/v3/contents/post/detail'\n    params = {\n        'pid': post_id,\n        'device': 0,\n        'v': 'v3.0.6-455336'\n    }\n    req = requests.get(url=url, headers=headers, params=params)\n    time.sleep(SLEEP_TIME)\n\n    if (req.status_code != 200):\n        print('  Error code:', req.status_code)\n        return get_post(page_id)\n    else:\n        print('  Success.')\n\n    content = json.loads(req.text)\n    post = content['post']['text']\n    reply = list(map(lambda x: (x['name'], x['text']), content['data']))\n    return post, reply\n\ndef dump_all_posts(pid_list):\n    Path('posts/').mkdir(exist_ok=True)\n    for post_id in pid_list:\n        post, reply = get_post(post_id)\n        with open('posts/{}.json'.format(post_id), 'w') as f:\n            json.dump({'post': post, 'reply': reply}, f)\n\ndef dump_as_html():\n    post_list = list(Path('posts').glob('*.json'))\n    post_list = sorted(post_list, key=lambda x:int(x.stem), reverse=True)\n\n    result_html = ''\n    for post_path in post_list:\n        with open(post_path) as f:\n            post = json.load(f)\n        result_html += f'<h1>{post_path.stem}</h1>'\n        result_html += post['post']\n        result_html += '<ul>'\n        for name, reply in post['reply']:\n            result_html += f'<li>[{name}] {reply}</li>'\n        result_html += '</ul>'\n\n    with open('result.html', 'w', encoding='utf-8') as f:\n        f.write(result_html)\n\nif __name__ == '__main__':\n    headers['token'] = input('Please enter token:')\n    attention_list = get_attention_list()\n    dump_all_posts(attention_list)\n    dump_as_html()\n```", "timestamp": 1639222406, "type": "text", "updated_at": 1639396258, "url": "", "vote": {}}}