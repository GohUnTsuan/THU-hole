{"code": 0, "data": [{"cid": 319452, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Alice", "pid": 63432, "reply_to": -1, "tag": null, "text": "闭社开发者回复了原贴 你看看呗", "timestamp": 1599323146, "type": "text", "url": ""}, {"cid": 319534, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Bob", "pid": 63432, "reply_to": -1, "tag": null, "text": "结论就是未名管理员和闭社开发者都不觉得是啥大事的样子", "timestamp": 1599324117, "type": "text", "url": ""}, {"cid": 321930, "deleted": false, "image_metadata": {}, "is_dz": false, "name": "Carol", "pid": 63432, "reply_to": -1, "tag": null, "text": "Re Bob: “没素质”=“不觉得是啥大事\"", "timestamp": 1599379662, "type": "text", "url": ""}], "post": {"deleted": false, "image_metadata": {}, "likenum": 3, "pid": 63432, "reply": 3, "tag": null, "text": "大瓜？https://bbs.pku.edu.cn/v2/post-read.php?bid=104&threadid=17779684\n清华闭社代码库中疑似使用未名BBS作CDN\n以下是配置部分，似乎指向未名 BBS 的 API：\nfrom datetime import timedelta\n\nSQLALCHEMY_DATABASE_URI='sqlite:///data.db'\nSQLALCHEMY_TRACK_MODIFICATIONS=False\nBASE_PATH='/system'\nFILE_PATH='/home/mastodon/live/public/system/'\n\nURL0 = 'https://bbs.pku.edu.cn/v2/post-new.php?bid=104&parentid=22838380'\nURL1 = 'https://bbs.pku.edu.cn/v2/ajax/upload.php'\nHEADERS = {\n        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',\n        'Accept-Encoding': 'gzip, deflate, br',\n        'Accept-Language': 'zh-CN',\n        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36',\n        'Origin': 'https://bbs.pku.edu.cn',\n        'Referer': URL0,\n        'Connection': 'keep-alive',\n        'Upgrade-Insecure-Requests': '1'\n        }\nEXP_TIME = timedelta(hours=1)\nCACHE_TIME = 21600\n\n\n\n以下是主代码：\nfrom flask import Flask, request, redirect\nfrom flask_sqlalchemy import SQLAlchemy\nfrom datetime import datetime, timedelta\nimport requests, re\n\napp = Flask(__name__)\napp.config.from_pyfile('config.py')\n\ndb = SQLAlchemy(app)\nclass Url(db.Model):\n    id   = db.Column(db.Integer, primary_key=True)\n    address = db.Column(db.String(128))\n    remote_url = db.Column(db.String(128))\n    update_time = db.Column(db.DateTime)\n    \n    def __init__(self, address, remote_url):\n        self.address = address\n        self.remote_url = remote_url\n        self.update_time = datetime.now()\n\n    def __repr__(self):\n        return '(%s)[%s]->[%s]' % (self.update_time, self.address, self.remote_url)\n\n\ndef upload(f):\n    with requests.Session() as s:\n        r = s.get(app.config['URL0'], headers=app.config['HEADERS'])\n        html = r.text\n        dir_id = re.findall('data-upload-dir=\"([0-9a-z]+)\"', html)[0]\n\n        files = {\n                'file': f\n                }\n        data = {\n                'dir': dir_id\n                }\n        r = s.post(app.config['URL1'], headers=app.config['HEADERS'], data=data, files=files)\n    \n    return r.json()\n\ndef test_404(url):\n    with requests.Session() as s:\n        r = s.head(url, headers=app.config['HEADERS'])\n\n    return r.status_code == 404\n\n@app.route('%s/<path:address>'%app.config['BASE_PATH'], methods=['GET'])\ndef get_file(address):\n    u = Url.query.filter_by(address=address).first() \n    if not u:\n       f = open(app.config['FILE_PATH']+'/'+address, 'rb')\n       app.logger.warning('First upload: %s', address)\n       u = Url(address, upload(f)['url'])\n       db.session.add(u)\n       db.session.commit()\n    elif datetime.now() - u.update_time > app.config['EXP_TIME'] and test_404(u.remote_url):\n       f = open(app.config['FILE_PATH']+'/'+address, 'rb')\n       app.logger.warning('Update: %s', address)\n       u.update_time = datetime.now()\n       u.remote_url = upload(f)['url']\n       db.session.commit()\n\n    resp = redirect(u.remote_url)\n    resp.headers.set('Cache-Control', 'public, max-age=%d'\n            % min(67, (app.config.get('CACHE_TIME') or int((u.update_time + app.config['EXP_TIME'] - datetime.now()).total_seconds())))\n            )\n    return resp\n\n\nif __name__ == '__main__':\n    app.run(debug=True)\n\n\n", "timestamp": 1599323056, "type": "text", "updated_at": 1606782615, "url": "", "vote": {}}}